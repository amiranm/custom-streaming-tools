<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./chatbox.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles:wght@700&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <title>Custom Chatbox</title>
</head>
<body>
    <div id="chat-box"></div>

    <script src="https://unpkg.com/comfy.js@latest/dist/comfy.min.js"></script>

     <script>
    const chatBox = document.getElementById("chat-box");
    let emoteMap = {};

    // Simulate incoming messages
    const fakeMessages = [
      { user: "Alice", text: "Hello everyone!" },
      { user: "Bob", text: "Nice stream so far." },
      { user: "superhellalongassusername", text: "How are you doing today? test for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wraptest for text to wrap" },
    ];

     // Fetch 7TV Global + Channel Emotes
  async function load7TVEmotes(channelName) {
    try {
      // Global emotes
      const globalRes = await fetch("https://7tv.io/v3/emote-sets/global");
      const globalData = await globalRes.json();

      globalData.emotes.forEach(emote => {
        emoteMap[emote.name] = `https://cdn.7tv.app/emote/${emote.id}/4x.webp`;
      });

      // Channel emotes
      const userRes = await fetch(`https://7tv.io/v3/users/twitch/${channelName}`);
      const userData = await userRes.json();

      userData.emote_set.emotes.forEach(emote => {
        emoteMap[emote.name] = `https://cdn.7tv.app/emote/${emote.id}/4x.webp`;
      });
    } catch (e) {
      console.error("Failed to load 7TV emotes", e);
    }
  }

  function renderMessage(user, message) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message");

    // Replace emote keywords with <img> tags
    const parsedMessage = message
      .split(" ")
      .map(word => {
        if (emoteMap[word]) {
          return `<img src="${emoteMap[word]}" alt="${word}" class="emote" />`;
        }
        return word;
      })
      .join(" ");

    msgDiv.innerHTML = `<p class="username">
        <img class="user-icon" src="./images/cat.svg" alt="cat icon">
        ${user}:
    </p> 
    <p class="message-body">${parsedMessage}</p>`;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  ComfyJS.onChat = (user, message) => {
    renderMessage(user, message);
  };

  // Replace with lowercase channel name
  const CHANNEL_NAME = "vgarroth";
  ComfyJS.Init(CHANNEL_NAME);
  load7TVEmotes(CHANNEL_NAME);
  </script>
</body>
</html>